<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Gara di Marco Antonio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .horse-flipped {
            transform: scaleX(-1) translateY(-50%);
        }
    </style>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAxqgScWEda7AoGWxWkFBCgVFjDvMks5SU",
            authDomain: "ombrelloni-ee9aa.firebaseapp.com",
            databaseURL: "https://ombrelloni-ee9aa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ombrelloni-ee9aa",
            storageBucket: "ombrelloni-ee9aa.firebasestorage.app",
            messagingSenderId: "781899782985",
            appId: "1:781899782985:web:0cb3c1c67cc57ddd9c1898"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const questions = [
            {
                question: "Quando e dove nasce e muore Marco Antonio?",
                answers: ["Roma 24 gennaio 83 a.C. / Alessandria d'Egitto 1 agosto 30 a.C.", "Roma 14 gennaio 84 a.C. / Roma 1 luglio 30 a.C.", "Roma 14 gennaio 83 a.C. / Alessandria d'Egitto 1 agosto 30 a.C.", "Alessandria 14 gennaio 83 a.C. / Roma 1 agosto 30 a.C."],
                correct: 2
            },
            {
                question: "Con chi condivise il potere nel Secondo Triunvirato?",
                answers: ["Cesare e Pompeo", "Ottaviano e Lepido", "Crasso e Cesare", "Bruto e Cassio"],
                correct: 1
            },
            {
                question: "Come si sono incontrati Marco Antonio e Cleopatra?",
                answers: ["Si sono incontrati nel 41 a.C. a Tarso, in Cilicia, quando Marco Antonio era alla ricerca di aiuti per la sua campagna contro i Parti.", "Marco Antonio e Cleopatra si incontrano durante la battaglia di Azio nel 31 a.C.", "Cleopatra era una regina romana e si sono incontrati a Roma", "Si sono incontrati ad Alessandria d'Egitto durante un banchetto"],
                correct: 0
            },
            {
                question: "In quale battaglia Marco Antonio sconfisse i congiurati che avevano ucciso Cesare?",
                answers: ["Battaglia di Modena", "Battaglia di Filippi", "Battaglia di Perugia", "Battaglia di Azio"],
                correct: 1
            },
            {
                question: "A chi fa Marco Antonio un elogio durante il suo funerale?",
                answers: ["Bruto", "Ottaviano", "Cesare", "Cleopatra"],
                correct: 2
            },
            {
                question: "Quale triumvirato form√≤ Marco Antonio?",
                answers: ["Primo Triumvirato", "Secondo Triumvirato", "Triumvirato Consolare", "Triumvirato Militare"],
                correct: 1
            },
            {
                question: "Chi sconfisse Marco Antonio nella battaglia di Azio?",
                answers: ["Giulio Cesare", "Ottaviano", "Pompeo", "Crasso"],
                correct: 1
            },
            {
                question: "Quale cognomen venne dato a Ottaviano dopo la vittoria su Marco Antonio?",
                answers: ["Imperator", "Augustus", "Caesar", "Maximus"],
                correct: 1
            },
            {
                question: "Come mor√¨ Marco Antonio?",
                answers: ["In battaglia", "Suicidio con la spada", "Avvelenamento", "Per malattia"],
                correct: 1
            },
            {
                question: "In quale citt√† mor√¨ Marco Antonio?",
                answers: ["Roma", "Atene", "Alessandria d'Egitto", "Cartagine"],
                correct: 2
            }
        ];

        const teams = ['Squadra 1', 'Squadra 2', 'Squadra 3'];
        const teamColors = ['#8B0000', '#800080', '#000000'];

        let gameState = {
            state: 'start',
            currentObstacle: 0,
            scores: { team1: 0, team2: 0, team3: 0 },
            teamAnswers: { team1: null, team2: null, team3: null },
            showQuestion: false,
            horsePosition: 0
        };

        function render() {
            const app = document.getElementById('app');
            
            if (gameState.state === 'start') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-b from-amber-700 to-amber-800 flex items-center justify-center p-4">
                        <div class="bg-stone-100 rounded-lg shadow-2xl p-8 max-w-md w-full text-center border-4 border-purple-900">
                            <h1 class="text-4xl font-bold text-red-950 mb-4">üèõÔ∏è La Gara di Marco Antonio</h1>
                            <p class="text-gray-800 mb-6">Tre squadre si sfidano rispondendo a domande sul grande generale romano, marito di Cleopatra!</p>
                            <button onclick="startGame()" class="bg-purple-900 hover:bg-purple-800 text-stone-100 font-bold py-3 px-8 rounded-lg text-xl transition border-2 border-stone-300">
                                Inizia la Gara
                            </button>
                        </div>
                    </div>
                `;
            } else if (gameState.state === 'finished') {
                const rankings = [
                    { team: 'Squadra 1', score: gameState.scores.team1, color: teamColors[0] },
                    { team: 'Squadra 2', score: gameState.scores.team2, color: teamColors[1] },
                    { team: 'Squadra 3', score: gameState.scores.team3, color: teamColors[2] }
                ].sort((a, b) => b.score - a.score);

                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-b from-amber-700 to-amber-800 flex items-center justify-center p-4">
                        <div class="bg-stone-100 rounded-lg shadow-2xl p-8 max-w-2xl w-full border-4 border-red-900">
                            <h1 class="text-4xl font-bold text-purple-950 mb-8 text-center">üèÜ Risultati Finali</h1>
                            
                            <div class="space-y-4 mb-8">
                                ${rankings.map((item, index) => `
                                    <div class="flex items-center justify-between p-4 bg-stone-200 rounded-lg border-2" style="border-color: ${item.color}">
                                        <div class="flex items-center gap-4">
                                            <span class="text-3xl font-bold text-gray-700">#${index + 1}</span>
                                            <span class="text-xl font-semibold" style="color: ${item.color}">${item.team}</span>
                                        </div>
                                        <span class="text-2xl font-bold" style="color: ${item.color}">${item.score} punti</span>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="bg-gradient-to-r from-amber-600 to-amber-700 p-6 rounded-lg text-center mb-6 border-4 border-amber-800">
                                <h2 class="text-3xl font-bold text-stone-100 mb-2">üéâ Vincitore üéâ</h2>
                                <p class="text-4xl font-bold text-stone-100">${rankings[0].team}</p>
                            </div>

                            <button onclick="showResetModal()" class="w-full bg-purple-900 hover:bg-purple-800 text-stone-100 font-bold py-3 px-8 rounded-lg text-xl transition border-2 border-stone-300">
                                Nuova Gara
                            </button>
                        </div>
                    </div>

                    <!-- Modal Password -->
                    <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                        <div class="bg-stone-100 rounded-lg shadow-2xl p-8 max-w-md w-full border-4 border-red-900">
                            <h2 class="text-2xl font-bold text-purple-950 mb-4 text-center">Inserisci Password</h2>
                            <p class="text-gray-800 mb-4 text-center">Per iniziare una nuova partita, inserisci la password:</p>
                            <input 
                                type="password" 
                                id="passwordInput" 
                                class="w-full p-3 border-2 border-gray-400 rounded-lg mb-4 text-center text-lg bg-white"
                                placeholder="Password"
                                onkeypress="if(event.key === 'Enter') checkPassword()"
                            >
                            <div id="passwordError" class="text-red-700 text-center mb-4 font-bold hidden">Password errata!</div>
                            <div class="flex gap-4">
                                <button onclick="hideResetModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-stone-100 font-bold py-3 px-6 rounded-lg transition">
                                    Annulla
                                </button>
                                <button onclick="checkPassword()" class="flex-1 bg-purple-900 hover:bg-purple-800 text-stone-100 font-bold py-3 px-6 rounded-lg transition">
                                    Conferma
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const currentQuestion = questions[gameState.currentObstacle];
                
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-b from-amber-700 to-amber-800 p-4">
                        <!-- Header con punteggi -->
                        <div class="max-w-6xl mx-auto mb-6">
                            <div class="grid grid-cols-3 gap-4">
                                ${teams.map((team, index) => `
                                    <div class="bg-stone-100 rounded-lg shadow-lg p-4 text-center border-4" style="border-color: ${teamColors[index]}">
                                        <h3 class="font-bold text-lg mb-2" style="color: ${teamColors[index]}">${team}</h3>
                                        <p class="text-3xl font-bold" style="color: ${teamColors[index]}">${gameState.scores[`team${index + 1}`]} pts</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Percorso -->
                        <div class="max-w-6xl mx-auto bg-stone-200 rounded-lg shadow-2xl p-8 mb-6 relative overflow-hidden border-4 border-stone-700" style="min-height: 400px">
                            <div class="relative h-64">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full h-2 bg-amber-700 rounded"></div>
                                </div>
                                
                                <!-- Ostacoli -->
                                ${[...Array(10)].map((_, index) => `
                                    <div class="absolute flex flex-col items-center" style="left: ${(index / 9) * 90 + 5}%; top: 50%; transform: translateY(-50%)">
                                        <div class="w-8 h-16 ${index < gameState.currentObstacle ? 'bg-gray-500' : index === gameState.currentObstacle ? 'bg-amber-600' : 'bg-red-900'} rounded mb-2 flex items-center justify-center text-stone-100 font-bold border-2 border-black">
                                            ${index + 1}
                                        </div>
                                    </div>
                                `).join('')}

                                <!-- Marco Antonio a cavallo (invertito) -->
                                <div class="absolute transition-all duration-1000 ease-in-out text-6xl horse-flipped" style="left: ${gameState.horsePosition}%; top: 50%">
                                    üèá
                                </div>
                            </div>

                            <div class="text-center mt-8">
                                <p class="text-gray-900 text-2xl font-bold mb-4">Ostacolo ${gameState.currentObstacle + 1} di 10</p>
                                ${!gameState.showQuestion ? `
                                    <button onclick="showQuestionModal()" class="bg-amber-600 hover:bg-amber-700 text-stone-100 font-bold py-3 px-8 rounded-lg text-xl transition border-2 border-amber-900">
                                        Mostra Domanda
                                    </button>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Domanda -->
                        ${gameState.showQuestion ? `
                            <div class="max-w-6xl mx-auto bg-stone-100 rounded-lg shadow-2xl p-8 border-4 border-stone-700">
                                <h2 class="text-2xl font-bold text-center mb-6 text-red-950">
                                    ${currentQuestion.question}
                                </h2>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    ${teams.map((team, teamIndex) => `
                                        <div class="border-4 rounded-lg p-4 bg-stone-50" style="border-color: ${teamColors[teamIndex]}">
                                            <h3 class="font-bold text-lg mb-4 text-center" style="color: ${teamColors[teamIndex]}">${team}</h3>
                                            <div class="space-y-2">
                                                ${currentQuestion.answers.map((answer, answerIndex) => `
                                                    <button
                                                        onclick="submitAnswer(${teamIndex}, ${answerIndex})"
                                                        class="w-full p-3 rounded-lg font-semibold transition border-2 ${
                                                            gameState.teamAnswers[`team${teamIndex + 1}`] === answerIndex
                                                                ? 'bg-amber-600 text-stone-100 border-amber-900'
                                                                : 'bg-stone-200 hover:bg-stone-300 border-gray-400 text-gray-900'
                                                        }"
                                                    >
                                                        ${answer}
                                                    </button>
                                                `).join('')}
                                            </div>
                                            ${gameState.teamAnswers[`team${teamIndex + 1}`] !== null ? `
                                                <p class="text-center mt-2 font-bold" style="color: ${teamColors[teamIndex]}">‚úì Risposta inviata</p>
                                            ` : `
                                                <p class="text-center mt-2 text-gray-600 font-bold">In attesa...</p>
                                            `}
                                        </div>
                                    `).join('')}
                                </div>

                                ${gameState.teamAnswers.team1 !== null && gameState.teamAnswers.team2 !== null && gameState.teamAnswers.team3 !== null ? `
                                    <div class="text-center">
                                        <button onclick="checkAnswers()" class="bg-purple-900 hover:bg-purple-800 text-stone-100 font-bold py-4 px-12 rounded-lg text-xl transition border-2 border-stone-300">
                                            Verifica Risposte e Prosegui
                                        </button>
                                    </div>
                                ` : `
                                    <div class="text-center">
                                        <p class="text-gray-700 text-lg font-semibold">In attesa che tutte le squadre rispondano...</p>
                                    </div>
                                `}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        window.startGame = async function() {
            await set(ref(database, 'marcoAntonioGame'), {
                gameState: 'playing',
                currentObstacle: 0,
                scores: { team1: 0, team2: 0, team3: 0 },
                teamAnswers: { team1: null, team2: null, team3: null },
                showQuestion: false,
                horsePosition: 0
            });
        };

        window.showQuestionModal = async function() {
            await update(ref(database, 'marcoAntonioGame'), {
                showQuestion: true,
                teamAnswers: { team1: null, team2: null, team3: null }
            });
        };

        window.submitAnswer = async function(teamIndex, answerIndex) {
            const teamKey = `team${teamIndex + 1}`;
            await update(ref(database, 'marcoAntonioGame/teamAnswers'), {
                [teamKey]: answerIndex
            });
        };

        window.checkAnswers = async function() {
            const correctAnswer = questions[gameState.currentObstacle].correct;
            const newScores = { ...gameState.scores };
            
            if (gameState.teamAnswers.team1 === correctAnswer) newScores.team1 += 10;
            if (gameState.teamAnswers.team2 === correctAnswer) newScores.team2 += 10;
            if (gameState.teamAnswers.team3 === correctAnswer) newScores.team3 += 10;

            const newPosition = gameState.currentObstacle + 1;
            const newHorsePosition = (newPosition / 10) * 100;

            if (newPosition >= 10) {
                await update(ref(database, 'marcoAntonioGame'), {
                    gameState: 'finished',
                    scores: newScores,
                    showQuestion: false,
                    horsePosition: 100
                });
            } else {
                await update(ref(database, 'marcoAntonioGame'), {
                    currentObstacle: newPosition,
                    scores: newScores,
                    showQuestion: false,
                    teamAnswers: { team1: null, team2: null, team3: null },
                    horsePosition: newHorsePosition
                });
            }
        };

        window.showResetModal = function() {
            const modal = document.getElementById('passwordModal');
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            if (modal && input && error) {
                modal.classList.remove('hidden');
                input.value = '';
                error.classList.add('hidden');
                setTimeout(() => input.focus(), 100);
            }
        };

        window.hideResetModal = function() {
            const modal = document.getElementById('passwordModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        window.checkPassword = async function() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            
            if (input.value === 'CLAUDIA') {
                await set(ref(database, 'marcoAntonioGame'), {
                    gameState: 'start',
                    currentObstacle: 0,
                    scores: { team1: 0, team2: 0, team3: 0 },
                    teamAnswers: { team1: null, team2: null, team3: null },
                    showQuestion: false,
                    horsePosition: 0
                });
                hideResetModal();
            } else {
                error.classList.remove('hidden');
                input.value = '';
                input.focus();
            }
        };

        // Listener Firebase
        const gameRef = ref(database, 'marcoAntonioGame');
        onValue(gameRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                gameState = {
                    state: data.gameState || 'start',
                    currentObstacle: data.currentObstacle || 0,
                    scores: data.scores || { team1: 0, team2: 0, team3: 0 },
                    teamAnswers: data.teamAnswers || { team1: null, team2: null, team3: null },
                    showQuestion: data.showQuestion || false,
                    horsePosition: data.horsePosition || 0
                };
                render();
            } else {
                render();
            }
        });

        // Render iniziale
        document.addEventListener('DOMContentLoaded', render);
    </script>
</head>
<body>
    <div id="app"></div>
</body>
</html>